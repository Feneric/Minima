#!/usr/bin/lua
--[[
Convert Minima Lua tables into JSON for more compact storage that uses fewer tokens.
--]]

json = require 'json'

-- For this to work in PICO-8, everything has to be crammed into a single line.
-- PICO-8 also wants embedded apostrophe characters escaped.
-- This returns the full line including the appropriate `json_parse` call so
-- it can be copied and pasted directly in.
function outputStructure(structureName, structure)
  structureJson = string.gsub(json.encode(structure), "'", "\\'")
  print(string.format("%s=json_parse('%s')", structureName, structureJson))
end

-- Our basetypes structure includes all of our objects and our bestiary.
basetypes={
  {
    hp=10,
    armor=1,
    dmg=13,
    dex=8,
    hostile=true,
    terrain={1,2,3,4,5,6,7,8,17,18,22,25,26,27,30,31,33,35},
    moveallowance=1,
    gold=10,
    exp=2,
    chance=1
  },{
    mapnum=0,
    minx=80,
    maxx=128,
    miny=0,
    maxy=64,
    newmonsters=0,
    maxmonsters=0,
    friendly=true
  },{
    mapnum=0,
    dungeon=true,
    startx=1,
    starty=1,
    startz=1,
    startfacing=1,
    minx=1,
    miny=1,
    maxx=9,
    maxy=9,
    newmonsters=25,
    maxmonsters=18,
    friendly=false,
    creatures={},
    songstart=17
  },{
    img=38,
    imgalt=38,
    name="ankh",
    talk={"yes, ankhs can talk.","shrines make good landmarks."}
  },{
    img=70,
    imgalt=70,
    name="ship",
    facingmatters=true,
    facing=2,
    passable=true
  },{
    img=92,
    imgalt=92,
    name="chest",
    passable=true
  },{
    img=39,
    flipimg=true,
    imgseq=12,
    name="fountain",
    sizemod=15,
    passable=true
  },{
    img=27,
    imgalt=27,
    name="ladder up",
    shiftmod=12,
    sizemod=20,
    passable=true
  },{
    img=26,
    imgalt=26,
    name="ladder down",
    shiftmod=-3,
    sizemod=20,
    passable=true
  },{
    name="human",
    img=75,
    armor=0,
    hostile=false,
    gold=5,
    exp=1
  },{
    name="orc",
    chance=8,
    talk={"urg!","grar!"}
  },{
    name="undead",
    dmg=14,
    dex=6,
    gold=5,
    chance=5
  },{
    name="animal",
    dex=10,
    armor=0,
    gold=0,
    chance=3
  },{
    img=82,
    colorsubs={{},{{1,12},{14,2},{15,4}}},
    name="fighter",
    hp=12,
    armor=3,
    dmg=20,
    dex=9,
    talk={"check out these pecs!","i\'m jacked!"}
  },{
    img=90,
    colorsubs={{},{{15,4}}},
    name="guard",
    moveallowance=0,
    hp=85,
    dmg=60,
    armor=12,
    talk={"behave yourself.","i protect good citizens."}
  },{
    img=75,
    flipimg=true,
    colorsubs={{},{{1,4},{4,15},{6,1},{14,13}},{{1,4},{6,5},{14,10}},{{1,4},{4,15},{6,1},{14,3}}},
    name="merchant",
    talk={"buy my wares!","consume!","stuff makes you happy!"}
  },{
    img=81,
    flipimg=true,
    colorsubs={{},{{2,9},{4,15},{13,14}},{{2,10},{4,15},{13,9}},{{2,11},{13,3}}},
    name="lady",
    talk={"pardon me.","well i never."}
  },{
    img=76,
    name="shepherd",
    colorsubs={{},{{6,5},{15,4}},{{6,5}},{{15,4}}},
    talk={"i like sheep.","the open air is nice."}
  },{
    img=78,
    name="jester",
    dex=12,
    talk={"ho ho ho!","ha ha ha!"}
  },{
    name="villain",
    armor=1,
    hostile=true,
    gold=15,
    exp=5,
    talk={"stand and deliver!","you shall die!"}
  },{
    name="grocer",
    merch='food'
  },{
    name="armorer",
    merch='armor'
  },{
    name="smith",
    merch='weapons'
  },{
    name="medic",
    merch='hospital'
  },{
    name="barkeep",
    merch='bar'
  },{
    img=96
  },{
    img=102,
    name="troll",
    hp=15,
    dmg=16,
    gold=10,
    exp=4
  },{
    img=104,
    names={"hobgoblin","bugbear"},
    hp=15,
    dmg=14,
    gold=8,
    exp=3
  },{
    img=114,
    names={"goblin","kobold"},
    hp=8,
    dmg=10,
    gold=5,
    exp=1
  },{
    img=118,
    flipimg=true,
    name="ettin",
    hp=20,
    dmg=18,
    exp=6,
    chance=1
  },{
    img=98,
    name="skeleton",
    gold=12
  },{
    img=100,
    names={"zombie","wight","ghoul"},
    hp=10
  },{
    img=123,
    flipimg=true,
    names={"phantom","ghost","wraith"},
    hp=15,
    terrain={1,2,3,4,5,6,7,8,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,33,35},
    exp=7,
    talk={'boooo!','feeear me!'}
  },{
    img=84,
    colorsubs={{},{{2,8},{15,4}}},
    names={"warlock","necromancer","sorcerer"},
    dmg=18,
    exp=10,
    talk={"i hex you!","a curse on you!"}
  },{
    img=88,
    colorsubs={{},{{1,5},{8,2},{4,1},{2,12},{15,4}}},
    names={"rogue","bandit","cutpurse"},
    dex=10,
    thief=true,
    chance=2
  },{
    img=86,
    colorsubs={{},{{1,5},{15,4}}},
    names={"ninja","assassin"},
    poison=true,
    gold=10,
    exp=8,
    talk={"you shall die at my hands.","you are no match for me."}
  },{
    img=106,
    name="giant spider",
    hp=18,
    poison=true,
    gold=8,
    exp=5
  },{
    img=108,
    name="giant rat",
    hp=5,
    dmg=10,
    poison=true,
    eat=true,
    exp=2
  },{
    img=112,
    names={"giant snake","serpent"},
    hp=20,
    poison=true,
    terrain={4,5,6,7},
    exp=6,
    chance=1
  },{
    img=116,
    name="sea serpent",
    hp=45,
    terrain={5,12,13,14,15,25},
    exp=10
  },{
    img=125,
    flipimg=true,
    name="megascorpion",
    hp=12,
    poison=true,
    exp=5,
    chance=1
  },{
    img=122,
    colorsubs={{},{{3,9},{11,10}},{{3,14},{11,15}}},
    flipimg=true,
    names={"slime","jelly","blob"},
    gold=5,
    terrain={17,22,23},
    eat=true,
    exp=2
  },{
    img=94,
    names={"kraken","giant squid"},
    hp=50,
    terrain={12,13,14,15},
    exp=8,
    chance=2
  },{
    img=120,
    flipimg=true,
    name="wisp",
    terrain={4,5,6},
    exp=3
  },{
    img=70,
    colorsubs={{{6,5},{7,6}}},
    flipimg=false,
    name="pirate",
    facingmatters=true,
    facing=1,
    terrain={12,13,14,15},
    exp=8
  },{
    img=119,
    colorsubs={{},{{2,14},{1,4}}},
    flipimg=true,
    names={"gazer","beholder"},
    terrain={17,22},
    exp=4
  },{
    img=121,
    flipimg=true,
    names={"dragon","drake","wyvern"},
    hp=50,
    armor=7,
    dmg=28,
    gold=20,
    exp=17
  },{
    img=110,
    names={"daemon","devil"},
    hp=50,
    armor=3,
    dmg=23,
    terrain={1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,22,25,26,27,30,31,33,35},
    gold=25,
    exp=15,
    chance=.25
  },{
    img=92,
    name="mimic",
    moveallowance=0,
    thief=true,
    gold=12,
    terrain={17,22},
    exp=4
  },{
    img=124,
    flipimg=true,
    name="reaper",
    moveallowance=0,
    armor=5,
    hp=30,
    gold=8,
    terrain={17,22},
    exp=5
  }
}
creature,towntype,dungeontype,ankhtype,shiptype,chesttype,fountaintype,ladderuptype,ladderdowntype,human,orc,undead,animal,fighter,guard,merchant,lady,shepherd,jester,villain,grocer,armorer,smith,medic,barkeep=basetypes[1],basetypes[2],basetypes[3],basetypes[4],basetypes[5],basetypes[6],basetypes[7],basetypes[8],basetypes[9],basetypes[10],basetypes[11],basetypes[12],basetypes[13],basetypes[14],basetypes[15],basetypes[16],basetypes[17],basetypes[18],basetypes[19],basetypes[20],basetypes[21],basetypes[22],basetypes[23],basetypes[24],basetypes[25]
outputStructure('basetypes', basetypes)

-- Our maps structure includes all of our communities and dungeons.
maps={
  {
    name="saugus",
    enterx=13,
    entery=4,
    startx=92,
    starty=23,
    maxx=105,
    maxy=24,
    signs={
      {xeno=92,yako=19,msg="welcome to saugus!"}
    },
    items={
      {idtype=4,xeno=84,yako=4}
    },
    creatures={
      {idtype=15,xeno=89,yako=21},
      {idtype=24,xeno=84,yako=9},
      {idtype=22,xeno=95,yako=3},
      {idtype=21,xeno=97,yako=13},
      {idtype=14,xeno=82,yako=21},
      {idtype=17,xeno=85,yako=16,talk={"poynter has a ship.","poynter is in lynn."}},
      {idtype=15,xeno=95,yako=21}
    }
  },{
    name="lynn",
    enterx=17,
    entery=4,
    startx=116,
    starty=23,
    minx=104,
    maxy=24,
    signs={
      {xeno=125,yako=9,msg="marina for members only."}
    },
    items={
      {idtype=5,xeno=125,yako=5}
    },
    creatures={
      {idtype=15,xeno=118,yako=22},
      {idtype=23,xeno=106,yako=1},
      {idtype=25,xeno=118,yako=2},
      {idtype=21,xeno=107,yako=9},
      {idtype=19,xeno=106,yako=16},
      {idtype=24,xeno=122,yako=12},
      {idtype=16,xeno=119,yako=6,talk={"i\'m rich! i have a yacht!","ho ho! i\'m the best!"}},
      {idtype=15,xeno=114,yako=22}
    }
  },{
    name="boston",
    enterx=45,
    entery=19,
    startx=96,
    starty=54,
    miny=24,
    maxx=112,
    maxy=56,
    items={
      {idtype=7,xeno=96,yako=40}
    },
    creatures={
      {idtype=15,xeno=94,yako=49},
      {idtype=23,xeno=103,yako=39},
      {idtype=22,xeno=92,yako=30},
      {idtype=21,xeno=88,yako=38},
      {idtype=24,xeno=100,yako=30},
      {idtype=19,xeno=96,yako=44},
      {idtype=14,xeno=83,yako=27},
      {idtype=16,xeno=110,yako=44,talk={"i\'ve seen the magic sword.","search south of the shrine."}},
      {idtype=15,xeno=105,yako=35,moveallowance=1},
      {idtype=15,xeno=98,yako=49}
    }
  },{
    name="salem",
    enterx=7,
    entery=36,
    startx=119,
    starty=62,
    minx=112,
    miny=43,
    items={
      {idtype=4,xeno=116,yako=53}
    },
    creatures={
      {idtype=15,xeno=118,yako=63},
      {idtype=23,xeno=125,yako=44},
      {idtype=25,xeno=114,yako=44},
      {idtype=21,xeno=122,yako=51},
      {idtype=17,xeno=118,yako=58},
      {idtype=14,xeno=123,yako=57,talk={"increase stats in dungeons!","only severe injuries work."}},
      {idtype=15,xeno=120,yako=63}
    }
  },{
    name="great misery",
    enterx=27,
    entery=35,
    startx=82,
    starty=59,
    miny=56,
    maxx=103,
    creatures={
      {idtype=21,xeno=93,yako=57},
      {idtype=25,xeno=100,yako=57},
      {idtype=18,xeno=82,yako=57},
      {idtype=18,xeno=102,yako=63,talk={"gilly is in boston.","gilly knows of the sword."}}
    }
  },{
    name="the dark tower",
    enterx=56,
    entery=44,
    startx=120,
    starty=41,
    minx=112,
    miny=24,
    maxy=43,
    friendly=false,
    newmonsters=35,
    maxmonsters=23,
    songstart=17,
    items={
      {idtype=8,xeno=117,yako=41,targetmap=10,targetx=3,targety=8,targetz=3},
      {idtype=6,xeno=119,yako=37},
      {idtype=6,xeno=119,yako=39},
      {idtype=6,xeno=120,yako=37},
      {idtype=6,xeno=120,yako=38},
      {idtype=6,xeno=120,yako=39},
      {idtype=6,xeno=121,yako=38},
      {idtype=6,xeno=121,yako=39}
    },
    creatures={
      {idtype=50,xeno=119,yako=41},
      {idtype=50,xeno=126,yako=40},
      {idtype=50,xeno=123,yako=38},
      {idtype=50,xeno=113,yako=40},
      {idtype=49,xeno=121,yako=37},
      {idtype=49,xeno=119,yako=38},
      {idtype=42,xeno=120,yako=34},
      {idtype=42,xeno=118,yako=35},
      {idtype=47,xeno=118,yako=30,propername="faxon",img=126,hp=255,armor=25,dmg=50}
    }
  },{
    name="nibiru",
    enterx=4,
    entery=11,
    starty=8,
    attr='int',
    levelstr="0x00000x3ffe0x03000x30300x3ffc0x33000x33fc0x00c00x00000xcccd0x03300x30300x3cfc0x03000x3fcc0x02c00x00000xf30c0x03fc0x300c0x333c0x33000xf3fc0x01c0",
    items={
      {idtype=8,xeno=1,yako=8,zabo=1},
      {idtype=8,xeno=8,yako=2,zabo=2},
      {idtype=8,xeno=4,yako=8,zabo=3},
      {idtype=7,xeno=6,yako=8,zabo=3}
    }
  },{
    name="purgatory",
    enterx=32,
    entery=5,
    attr='str',
    levelstr="0x03380x3f3c0x03000x33f00xf03c0x33000x33fc0x03000x33040x333c0x000c0x3fcc0x30fc0x3c000x3bcf0x03000x03040x333c0x30300xff3c0x00300x3f0c0x373c0x0330",
    items={
      {idtype=8,xeno=1,yako=1,zabo=1},
      {idtype=8,xeno=7,yako=1,zabo=2},
      {idtype=8,xeno=3,yako=7,zabo=3},
      {idtype=7,xeno=7,yako=5,zabo=3}
    }
  },{
    name="sheol",
    enterx=33,
    entery=58,
    attr='dex',
    levelstr="0x03000x3fb00x03fc0x33000x33f30x30000xfffc0x00000x03000x337c0x300f0x3ffe0x00fc0x3c000x33cf0x30000x03000x333c0x303c0x33310x333f0x330c0x333c0x0000",
    items={
      {idtype=8,xeno=1,yako=1,zabo=1},
      {idtype=8,xeno=5,yako=2,zabo=2},
      {idtype=8,xeno=8,yako=4,zabo=3},
      {idtype=7,xeno=6,yako=6,zabo=3}
    }
  },{
    name="the upper levels",
    enterx=124,
    entery=26,
    startx=8,
    startz=3,
    mapnum=6,
    levelstr="0x00c00xbcce0xfccf0x00cc0x3fcc0x0ccc0x00cc0x0c000x00c00x7ccd0x3fc30x38f00x3cc30x0ccc0x3cce0x00c00x00c00xcccf0x0cc00x34fc0x3fc00x00cf0x33cd0x3b00",
    items={
      {idtype=9,xeno=8,yako=1,zabo=3},
      {idtype=9,xeno=3,yako=8,zabo=3,targetmap=6,targetx=117,targety=41,targetz=0},
      {idtype=8,xeno=8,yako=7,zabo=3},
      {idtype=8,xeno=3,yako=4,zabo=3},
      {idtype=8,xeno=1,yako=2,zabo=2},
      {idtype=8,xeno=8,yako=2,zabo=2}
    },
    creatures={
      {idtype=50,xeno=6,yako=8,zabo=3},
      {idtype=50,xeno=8,yako=4,zabo=3},
      {idtype=50,xeno=3,yako=1,zabo=3},
      {idtype=50,xeno=6,yako=6,zabo=2},
      {idtype=50,xeno=6,yako=8,zabo=1}
    }
  }
}
outputStructure('maps', maps)
